<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Linux File Browser</title>
        <link rel="stylesheet" href="/css/style.css" />
    </head>

    <body>
        <h2>Linux File Browser</h2>

        <button onclick="location.href = '/config.html'">⚙ Settings</button>

        <br /><br />

        <div id="systemInfo">Loading system info...</div>

        <div id="path"></div>
        <button onclick="goUp()">⬆ Up</button>

        <br /><br />

        <label>Size Unit:</label>
        <select id="unit" onchange="reload()">
            <option value="bit">bit</option>
            <option value="kb">KB</option>
            <option value="mb">MB</option>
            <option value="gb">GB</option>
        </select>

        <label>Type:</label>
        <select id="typeFilter" onchange="reload()">
            <option value="all">All</option>
            <option value="dir">Dir</option>
            <option value="file">File</option>
        </select>

        <label>Search:</label>
        <input
            type="text"
            id="searchBox"
            oninput="reload()"
            placeholder="file name..."
        />

        <label>Sort:</label>
        <select id="sortBy" onchange="reload()">
            <option value="name">Name</option>
            <option value="size">Size</option>
            <option value="date">Date</option>
        </select>

        <select id="sortOrder" onchange="reload()">
            <option value="asc">Asc</option>
            <option value="desc">Desc</option>
        </select>

        <br /><br />

        <table>
            <thead>
                <tr>
                    <th>Mode</th>
                    <th>Perm</th>
                    <th>Links</th>
                    <th>Owner</th>
                    <th>Group</th>
                    <th>Size</th>
                    <th>Modified</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>

        <!-- ===== モーダル ===== -->

        <div id="fileModal" class="modal">
            <div class="modal-header">
                <button id="closeModal">✕</button>
            </div>
            <pre id="fileContent"></pre>
        </div>

        <script>
            let currentPath = "/";
            let currentData = [];

            function openFile(path) {
                fetch("/api/file?path=" + encodeURIComponent(path))
                    .then((res) => {
                        if (!res.ok) throw new Error("Cannot open file");
                        return res.text();
                    })
                    .then((text) => {
                        document.getElementById("fileContent").textContent =
                            text;
                        document.getElementById("fileModal").style.display =
                            "block";
                    })
                    .catch((err) => alert(err.message));
            }

            function closeModal() {
                document.getElementById("fileModal").style.display = "none";
                document.getElementById("fileContent").textContent = "";
            }

            function loadSystemInfo() {
                fetch("/api/system")
                    .then((res) => res.json())
                    .then((data) => {
                        document.getElementById("systemInfo").innerHTML = `
                        <b>Hostname:</b> ${data.hostname} |
                        <b>Distribution:</b> ${data.distribution} |
                        <b>Kernel:</b> ${data.kernel} |
                        <b>Arch:</b> ${data.arch}
                    `;
                    })
                    .catch(() => {
                        document.getElementById("systemInfo").innerText =
                            "Failed to load system information";
                    });
            }

            /**
             * バイト数を選択された単位に変換する
             *
             * @param {number} bytes - ファイルサイズ（バイト）
             * @returns {string} 変換後のサイズ文字列
             */
            function convertSize(bytes) {
                const unit = document.getElementById("unit").value;

                if (unit === "bit") return bytes * 8 + " bit";
                if (unit === "kb") return (bytes / 1024).toFixed(2) + " KB";
                if (unit === "mb")
                    return (bytes / (1024 * 1024)).toFixed(2) + " MB";
                if (unit === "gb")
                    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";

                return bytes + " B";
            }
            /**
             * パーミッション文字列から表示色を決定する関数
             *
             * 例:
             *  777 → 危険（赤）
             *  書き込み権限あり → オレンジ
             *  実行権限あり → 緑
             *  それ以外 → 黄色
             *
             * @param {Object} item - APIから取得したファイル情報オブジェクト
             * @returns {string} CSSカラーコード
             */
            function getPermColor(item) {
                if (!item.perm) return "#ffffff";

                // 777 は危険（赤）
                if (item.perm === "777") return "#ff4d4d";

                // 書き込み権限あり（オレンジ）
                if (/[2367]/.test(item.perm)) return "#ffa500";

                // 実行権限あり（緑）
                if (/[1357]/.test(item.perm)) return "#00cc66";

                // それ以外
                return "#f5c542";
            }

            function render(data, path) {
                const tbody = document.getElementById("list");
                tbody.innerHTML = "";

                const filter = document.getElementById("typeFilter").value;
                const keyword = document
                    .getElementById("searchBox")
                    .value.toLowerCase();
                const sortBy = document.getElementById("sortBy").value;
                const sortOrder = document.getElementById("sortOrder").value;

                let filtered = data.filter((item) => {
                    if (filter === "dir" && !item.is_dir) return false;
                    if (filter === "file" && item.is_dir) return false;
                    if (keyword && !item.name.toLowerCase().includes(keyword))
                        return false;
                    return true;
                });

                filtered.sort((a, b) => {
                    let valA, valB;

                    if (sortBy === "name") {
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                    } else if (sortBy === "size") {
                        valA = a.size;
                        valB = b.size;
                    } else {
                        valA = new Date(a.mod_time);
                        valB = new Date(b.mod_time);
                    }

                    if (valA < valB) return sortOrder === "asc" ? -1 : 1;
                    if (valA > valB) return sortOrder === "asc" ? 1 : -1;
                    return 0;
                });

                filtered.forEach((item) => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                    <td>${item.mode}</td>
                    <td>
                        <span style="color:${getPermColor(item)}; font-weight:bold">
                            ${item.perm}
                        </span>
                    </td>
                    <td>${item.nlink}</td>
                    <td>${item.owner}</td>
                    <td>${item.group}</td>
                    <td>${convertSize(item.size)}</td>
                    <td>${item.mod_time}</td>
                `;

                    const nameCell = document.createElement("td");
                    const span = document.createElement("span");
                    span.textContent = item.name;
                    span.style.cursor = "pointer";

                    if (item.is_dir) {
                        span.classList.add("name-cell", "dir-icon");
                        span.onclick = () => {
                            const newPath =
                                path === "/"
                                    ? "/" + item.name
                                    : path + "/" + item.name;
                            load(newPath);
                        };
                    } else {
                        span.classList.add("name-cell", "file-icon");
                        span.onclick = () => {
                            const filePath =
                                path === "/"
                                    ? "/" + item.name
                                    : path + "/" + item.name;
                            openFile(filePath);
                        };
                    }

                    nameCell.appendChild(span);
                    row.appendChild(nameCell);
                    tbody.appendChild(row);
                });
            }

            function load(path) {
                fetch("/api/list?path=" + encodeURIComponent(path))
                    .then((res) => {
                        if (!res.ok)
                            throw new Error("API Error: " + res.status);
                        return res.json();
                    })
                    .then((data) => {
                        currentPath = path;
                        currentData = data;
                        document.getElementById("path").innerText =
                            "Current: " + path;
                        render(data, path);
                    })
                    .catch((err) => alert(err.message));
            }

            function reload() {
                render(currentData, currentPath);
            }

            function goUp() {
                if (currentPath === "/") return;

                let parts = currentPath.split("/");
                parts.pop();
                let newPath = parts.join("/");
                if (newPath === "") newPath = "/";

                load(newPath);
            }

            window.addEventListener("DOMContentLoaded", function () {
                document.getElementById("closeModal").onclick = closeModal;

                document
                    .getElementById("fileModal")
                    .addEventListener("click", function (e) {
                        if (e.target.id === "fileModal") closeModal();
                    });

                document.addEventListener("keydown", function (e) {
                    if (e.key === "Escape") closeModal();
                });

                loadSystemInfo();
                load("/");
            });
        </script>
    </body>
</html>
